with `IssuerDetails` as (select '002' AS `issuer_code`,'광주카드' AS `issuer_name` union all select '058' AS `058`,'산업은행' AS `산업은행` union all select '006' AS `006`,'하나카드' AS `하나카드` union all select '081' AS `081`,'은련카드' AS `은련카드` union all select '008' AS `008`,'외환카드' AS `외환카드` union all select '126' AS `126`,'저축은행' AS `저축은행` union all select '010' AS `010`,'전북카드' AS `전북카드` union all select '226' AS `226`,'우체국' AS `우체국` union all select '011' AS `011`,'제주카드' AS `제주카드` union all select '326' AS `326`,'새마을금고' AS `새마을금고` union all select '015' AS `015`,'우리카드' AS `우리카드` union all select '426' AS `426`,'중국은행' AS `중국은행` union all select '016' AS `016`,'국민카드' AS `국민카드` union all select '526' AS `526`,'하나 BC 카드' AS `하나 BC 카드` union all select '017' AS `017`,'수협카드' AS `수협카드` union all select '626' AS `626`,'신협' AS `신협` union all select '018' AS `018`,'농협카드' AS `농협카드` union all select '726' AS `726`,'현대증권' AS `현대증권` union all select '022' AS `022`,'씨티카드' AS `씨티카드` union all select '826' AS `826`,'교보증권' AS `교보증권` union all select '026' AS `026`,'비씨카드' AS `비씨카드` union all select '926' AS `926`,'유진투자증권' AS `유진투자증권` union all select '027' AS `027`,'현대카드' AS `현대카드` union all select 'A16' AS `A16`,'카카오뱅크' AS `카카오뱅크` union all select '028' AS `028`,'JCB 카드' AS `JCB 카드` union all select 'A26' AS `A26`,'IBK 기업' AS `IBK 기업` union all select '029' AS `029`,'신한카드' AS `신한카드` union all select 'B26' AS `B26`,'SK 증권' AS `SK 증권` union all select '031' AS `031`,'삼성카드' AS `삼성카드` union all select 'C26' AS `C26`,'K 뱅크' AS `K 뱅크` union all select '046' AS `046`,'해외 AMEX' AS `해외 AMEX` union all select '047' AS `047`,'롯데' AS `롯데` union all select '048' AS `048`,'해외다이너스' AS `해외다이너스` union all select 'F26' AS `F26`,'부산은행' AS `부산은행` union all select '049' AS `049`,'해외 MASTER' AS `해외 MASTER` union all select 'G26' AS `G26`,'SC 제일은행' AS `SC 제일은행` union all select '050' AS `050`,'해외 VISA' AS `해외 VISA` union all select 'H26' AS `H26`,'경남은행' AS `경남은행`), `RefundBankCompany` as (select 'INDUSTRIAL' AS `bank_code`,'산업은행' AS `bank_code_name` union all select 'IBK' AS `IBK`,'기업은행' AS `기업은행` union all select 'KB' AS `KB`,'국민은행' AS `국민은행` union all select 'WOOHAN' AS `WOOHAN`,'외환은행' AS `외환은행` union all select 'SUHYUP' AS `SUHYUP`,'수협은행' AS `수협은행` union all select 'NOHUP' AS `NOHUP`,'농협은행' AS `농협은행` union all select 'DNH' AS `DNH`,'단위농협' AS `단위농협` union all select 'URI' AS `URI`,'우리은행' AS `우리은행` union all select 'SC_JEIL_BANK' AS `SC_JEIL_BANK`,'SC제일은행' AS `SC제일은행` union all select 'SHINHAN_026' AS `SHINHAN_026`,'신한은행' AS `신한은행` union all select 'CITI' AS `CITI`,'한국씨티은행' AS `한국씨티은행` union all select 'DAEGU' AS `DAEGU`,'대구은행' AS `대구은행` union all select 'BUSAN_BANK' AS `BUSAN_BANK`,'부산은행' AS `부산은행` union all select 'GWANGJU' AS `GWANGJU`,'광주은행' AS `광주은행` union all select 'JEJU' AS `JEJU`,'제주은행' AS `제주은행` union all select 'JEONBUK' AS `JEONBUK`,'전북은행' AS `전북은행` union all select 'KYUNGNAM_BANK' AS `KYUNGNAM_BANK`,'경남은행' AS `경남은행` union all select 'SAEMAEUL_GEUMGO' AS `SAEMAEUL_GEUMGO`,'새마을' AS `새마을` union all select 'SHINHYUP' AS `SHINHYUP`,'신협' AS `신협` union all select 'SANGHO_BANK' AS `SANGHO_BANK`,'상호저축은행' AS `상호저축은행` union all select 'FOREST' AS `FOREST`,'산림조합' AS `산림조합` union all select 'POST_OFFICE' AS `POST_OFFICE`,'우체국' AS `우체국` union all select 'HANA_BANK' AS `HANA_BANK`,'KEB하나은행' AS `KEB하나은행` union all select 'SINHAN_088' AS `SINHAN_088`,'신한은행' AS `신한은행` union all select 'K_BANK' AS `K_BANK`,'K뱅크 카드' AS `K뱅크 카드` union all select 'KAKAOBANK' AS `KAKAOBANK`,'카카오뱅크' AS `카카오뱅크` union all select 'TOSS_BANK' AS `TOSS_BANK`,'토스뱅크' AS `토스뱅크` union all select 'KB_SECURITIES' AS `KB_SECURITIES`,'KB증권' AS `KB증권` union all select 'KTB_INVESTMENT_SECURITIES' AS `KTB_INVESTMENT_SECURITIES`,'KTB투자증권' AS `KTB투자증권` union all select 'MIRAESK_DAEWU' AS `MIRAESK_DAEWU`,'미래에셋' AS `미래에셋` union all select 'SAMSUNG_SECURITIES' AS `SAMSUNG_SECURITIES`,'삼성증권' AS `삼성증권` union all select 'KOREA_INVESTMENT_SECURITIES' AS `KOREA_INVESTMENT_SECURITIES`,'한국투자증권' AS `한국투자증권` union all select 'NH_INVESTMENT_SECURITIES' AS `NH_INVESTMENT_SECURITIES`,'NH투자증권' AS `NH투자증권` union all select 'KYOBOW_SECURITIES' AS `KYOBOW_SECURITIES`,'교보증권' AS `교보증권` union all select 'HI_INVESTMENT_SECURITIES' AS `HI_INVESTMENT_SECURITIES`,'하이투자증권 MASTER' AS `하이투자증권 MASTER` union all select 'HMC_SECURITIES' AS `HMC_SECURITIES`,'HMC증권 제일은행' AS `HMC증권 제일은행` union all select 'KIWOOM_SECURITIES' AS `KIWOOM_SECURITIES`,'키움증권 VISA' AS `키움증권 VISA` union all select 'IBEST_INVESTMENT_SECURITIES' AS `IBEST_INVESTMENT_SECURITIES`,'이베스트투자증권' AS `이베스트투자증권`), `MonthlyRevenue` as (select `tb_order_split`.`order_seq` AS `order_seq`,date_format(`tb_order_split`.`revenue_dt`,'%Y-%m') AS `revenue_month`,max(`tb_order_split`.`monthly_revenue_base_amount`) AS `monthly_amount` from `tb_order_split` group by `tb_order_split`.`order_seq`,date_format(`tb_order_split`.`revenue_dt`,'%Y-%m')), `OriginalData` as (select `bos`.`business_order_sheet_seq` AS `business_order_sheet_seq`,`bos`.`order_status` AS `order_status`,`tor`.`status` AS `status`,coalesce(`tor`.`hi_dms_idx`,0) AS `HiDmsIdx`,coalesce(`tpl`.`parking_code`,'') AS `CostCenterCode`,coalesce(`tor`.`order_no`,'') AS `TicketID`,coalesce(`bos`.`order_sheet_no`,'') AS `OrderSheetID`,coalesce(`tor`.`car_number`,'') AS `VehicleRegisterationNo`,coalesce(`tor`.`service_start_dt`,`bos`.`service_start_dt`,'1900-01-01') AS `FromDate`,coalesce(`tor`.`service_end_dt`,`bos`.`service_end_dt`,'1900-01-01') AS `ToDate`,(case coalesce(`tor`.`pay_method_type`,`bos`.`payment_method`,'CASH') when 'CARD' then 'CARD' when 'FIXED_ACCT' then 'FIXED_ACCT' else 'CASH' end) AS `PaymentType`,(case when ((`bos`.`payment_method` = 'FIXED_ACCT') and (`bos_tt`.`status` in ('APPROVAL_CANCELED','PURCHASE_CANCELED','UNPAID_CLOSED'))) then 'X' when ((`bos`.`payment_method` = 'FIXED_ACCT') and (`bos`.`order_status` in ('PENDING','IN_USE','RESERVED','FINISHED','PAYMENT_PENDING'))) then 'A' when ((`bos`.`payment_method` = 'FIXED_ACCT') and (`bos`.`order_status` in ('CANCEL_COMPLETED','CANCEL_ON_HOLD','CANCEL_REQUESTED','CANCEL_SCHEDULED','RESERVE_CANCELLED'))) then 'C' when (`tt`.`status` in ('APPROVED','PURCHASE_REQUEST','DEPOSIT_COMPLETED')) then 'A' when (`tt`.`status` in ('APPROVAL_CANCELED','PURCHASE_CANCELED','UNPAID_CLOSED')) then 'C' when (`tt`.`status` = 'PARTIAL_PURCHASE_CANCELED') then 'P' when (`bos_tt`.`status` in ('APPROVED','PURCHASE_REQUEST','DEPOSIT_COMPLETED')) then 'A' when (`bos_tt`.`status` in ('APPROVAL_CANCELED','PURCHASE_CANCELED','UNPAID_CLOSED')) then 'C' when ((`tora`.`refund_amount` is null) and (`tor`.`status` = 'CANCEL_COMPLETED')) then 'C' end) AS `ApprovalType`,(case when ((`tor`.`business_order_sheet_seq` is not null) and (`bos_tt`.`transaction_date` is not null)) then str_to_date(`bos_tt`.`transaction_date`,'%Y%m%d%H%i%s') when (`tt`.`transaction_date` is not null) then str_to_date(`tt`.`transaction_date`,'%Y%m%d%H%i%s') else NULL end) AS `TransactionDate`,if((`tt`.`origin` is null),coalesce(`tor`.`order_amount`,`bos`.`order_amount`,0),-(coalesce(`tt`.`amount`,0))) AS `SalesPrice`,if((`tt`.`origin` is null),0,NULL) AS `DiscountPrice`,(case when (`tu`.`name` is not null) then cast(aes_decrypt(from_base64(`tu`.`name`),'I58VsFt3l4ZGYDeX') as char charset utf8mb4) when (`tbu`.`employee_name` is not null) then cast(aes_decrypt(from_base64(`tbu`.`employee_name`),'I58VsFt3l4ZGYDeX') as char charset utf8mb4) else '' end) AS `BuyerName`,(case when (`tu`.`phone` is not null) then cast(aes_decrypt(from_base64(`tu`.`phone`),'I58VsFt3l4ZGYDeX') as char charset utf8mb4) when (`tbu`.`phone_number` is not null) then cast(aes_decrypt(from_base64(`tbu`.`phone_number`),'I58VsFt3l4ZGYDeX') as char charset utf8mb4) else '' end) AS `Phone`,coalesce((select `tb_trade`.`card_no` from `tb_trade` where (`tb_trade`.`trade_seq` = `tt`.`origin`) limit 1),`tt`.`card_no`,`bos_tt`.`card_no`,'') AS `CreditCardNo`,coalesce((select `tb_trade`.`approval_no` from `tb_trade` where (`tb_trade`.`trade_seq` = `tt`.`origin`) limit 1),`tt`.`approval_no`,(select `tb_trade`.`approval_no` from `tb_trade` where (`tb_trade`.`trade_seq` = `bos_tt`.`origin`) limit 1),`bos_tt`.`approval_no`,'') AS `CreditCardApprovalNo`,coalesce(`tt`.`pg_cno`,`bos_tt`.`pg_cno`,'') AS `TransactionID`,coalesce(`id`.`issuer_name`,`bos_tt`.`issuer_name`,'') AS `IssueCreditCard`,coalesce(`id`.`issuer_name`,`bos_tt`.`issuer_name`,'') AS `SettleCreditCard`,coalesce(`tor`.`hold_reason`,'') AS `Remark`,coalesce(`tp`.`name`,'') AS `ProductName`,coalesce(`tp`.`product_type`,'') AS `ProductType`,coalesce(`tt`.`cash_auth_no`,`bos_tt`.`cash_auth_no`,'') AS `CashbillID`,coalesce(`tt`.`cash_tran_date`,`bos_tt`.`cash_tran_date`,'') AS `CashTradeDate`,coalesce((case when (`tor`.`business_order_sheet_seq` is not null) then (case when (`tbcr`.`receipt_type` = 'INCOME_DEDUCTION') then `tbcr`.`phone_number` when (`tbcr`.`receipt_type` = 'EXPENSE_PROOF') then `tbcr`.`business_number` else '' end) when (`tor`.`business_order_sheet_seq` is null) then `tucr`.`issue_info` end),'') AS `CashIdentifyNo`,NULL AS `CashEmailAddress`,coalesce(`mr`.`revenue_month`,'') AS `SalesDate`,coalesce(`mr`.`monthly_amount`,0) AS `StandardPrice`,coalesce(`tor`.`last_modified_date`,'') AS `LastModifiedDate` from ((((((((((((((`tb_order` `tor` left join `tb_trade` `tt` on((`tt`.`order_seq` = `tor`.`order_seq`))) left join `tb_product` `tp` on((`tor`.`product_seq` = `tp`.`product_seq`))) left join `tb_parking_lot` `tpl` on((`tp`.`parking_lot_seq` = `tpl`.`parking_lot_seq`))) left join `tb_user` `tu` on((`tor`.`user_seq` = `tu`.`user_seq`))) left join `tb_user_cash_receipt` `tucr` on((`tu`.`user_cash_receipt_seq` = `tucr`.`user_cash_receipt_seq`))) left join `tb_order_refund_account` `tora` on((`tor`.`order_refund_account_seq` = `tora`.`order_refund_account_seq`))) left join `RefundBankCompany` `rid` on((`tora`.`bank_code` = `rid`.`bank_code`))) left join `IssuerDetails` `id` on((`tt`.`issuer_code` = `id`.`issuer_code`))) left join `MonthlyRevenue` `mr` on((`mr`.`order_seq` = `tor`.`order_seq`))) left join `rtb_business_group_user_mapping` `tbgum` on((`tor`.`group_user_mapping_seq` = `tbgum`.`group_user_mapping_seq`))) left join `tb_business_user_info` `tbu` on((`tbgum`.`biz_user_info_seq` = `tbu`.`biz_user_info_seq`))) left join `tb_business_order_sheet` `bos` on((`tor`.`business_order_sheet_seq` = `bos`.`business_order_sheet_seq`))) left join `tb_trade` `bos_tt` on((`bos`.`business_order_sheet_seq` = `bos_tt`.`business_order_sheet_seq`))) left join `tb_business_cash_receipt` `tbcr` on((`bos`.`business_order_sheet_seq` = `tbcr`.`business_order_sheet_seq`))) where ((((`tor`.`status` in ('CREATION_PENDING','PENDING')) and (`bos`.`payment_method` = 'FIXED_ACCT')) or (`tor`.`status` <> 'PENDING')) and ((`bos`.`order_status` <> 'CREATION_PENDING') or (`tor`.`business_order_sheet_seq` is null)) and (`tor`.`status` <> 'CREATION_CANCEL') and ((`tor`.`order_amount` > 0) or ((`tor`.`business_order_sheet_seq` is not null) and exists(select 1 from `tb_business_order_sheet` `bos` where ((`bos`.`business_order_sheet_seq` = `tor`.`business_order_sheet_seq`) and (`bos`.`order_amount` > 0)))))) order by `tor`.`order_seq` desc) select `OriginalData`.`business_order_sheet_seq` AS `business_order_sheet_seq`,`OriginalData`.`order_status` AS `order_status`,`OriginalData`.`status` AS `status`,`OriginalData`.`HiDmsIdx` AS `HiDmsIdx`,`OriginalData`.`CostCenterCode` AS `CostCenterCode`,`OriginalData`.`TicketID` AS `TicketID`,`OriginalData`.`OrderSheetID` AS `OrderSheetID`,`OriginalData`.`VehicleRegisterationNo` AS `VehicleRegisterationNo`,`OriginalData`.`FromDate` AS `FromDate`,`OriginalData`.`ToDate` AS `ToDate`,`OriginalData`.`PaymentType` AS `PaymentType`,`OriginalData`.`ApprovalType` AS `ApprovalType`,`OriginalData`.`TransactionDate` AS `TransactionDate`,`OriginalData`.`SalesPrice` AS `SalesPrice`,`OriginalData`.`DiscountPrice` AS `DiscountPrice`,`OriginalData`.`BuyerName` AS `BuyerName`,`OriginalData`.`Phone` AS `Phone`,`OriginalData`.`CreditCardNo` AS `CreditCardNo`,`OriginalData`.`CreditCardApprovalNo` AS `CreditCardApprovalNo`,`OriginalData`.`TransactionID` AS `TransactionID`,`OriginalData`.`IssueCreditCard` AS `IssueCreditCard`,`OriginalData`.`SettleCreditCard` AS `SettleCreditCard`,`OriginalData`.`Remark` AS `Remark`,`OriginalData`.`ProductName` AS `ProductName`,`OriginalData`.`ProductType` AS `ProductType`,`OriginalData`.`CashbillID` AS `CashbillID`,`OriginalData`.`CashTradeDate` AS `CashTradeDate`,`OriginalData`.`CashIdentifyNo` AS `CashIdentifyNo`,`OriginalData`.`CashEmailAddress` AS `CashEmailAddress`,`OriginalData`.`SalesDate` AS `SalesDate`,`OriginalData`.`StandardPrice` AS `StandardPrice`,`OriginalData`.`LastModifiedDate` AS `LastModifiedDate` from `OriginalData` where (`OriginalData`.`ApprovalType` is not null)