{% extends "layout.html" %}

{% block content %}

<div class="container mx-auto px-6 py-10">

    <!-- ì œëª© -->
    <div class="bg-gradient-to-br from-white to-orange-50 rounded-2xl shadow-xl p-8 mb-10 border border-orange-200">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-14 h-14 bg-gradient-to-br from-[#ff6b35] to-[#ff8c5a] rounded-xl flex items-center justify-center">
                <i class="lucide-terminal text-white text-2xl"></i>
            </div>
            <h2 class="text-gray-900 text-2xl font-bold">ì¿¼ë¦¬ ì‹¤í–‰ (SQL Runner)</h2>
        </div>

        <!-- ì„¸ë¡œ ì •ë ¬ -->
        <div class="flex flex-col gap-6">

            <!-- í™˜ê²½ ì„ íƒ -->
            <div class="flex flex-col">
                <label class="text-gray-700 font-medium mb-1">í™˜ê²½ ì„ íƒ</label>
                <select id="env"
                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ff6b35] w-60">
                    <option value="prod">PROD</option>
                    <option value="stage">STAGE</option>
                </select>
            </div>

            <!-- SQL ì…ë ¥ -->
            <div class="flex flex-col">
                <label class="text-gray-700 font-medium mb-1">SQL ì…ë ¥</label>
                <textarea id="sql"
                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ff6b35] w-full resize-none"
                    style="height: 160px;"></textarea>
            </div>

            <!-- ì‹¤í–‰/ì—‘ì…€ ë²„íŠ¼ -->
            <div class="flex gap-4 mt-1">

                <button onclick="runQuery()"
                    class="px-8 py-3 rounded-lg shadow font-semibold"
                    style="background:#ff6b35; color:white;">
                    ì‹¤í–‰
                </button>

                <button onclick="downloadExcel()"
                    class="px-8 py-3 rounded-lg shadow font-semibold"
                    style="background:#0f9d58; color:white;">
                    ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>

            </div>

        </div>

        <div id="loading" class="mt-4 hidden">
            <span class="text-gray-600">â³ ì‹¤í–‰ ì¤‘...</span>
        </div>
    </div>

    <!-- ì—¬ê¸° ê²°ê³¼ ì¶œë ¥ -->
    <div id="results" class="bg-white rounded-2xl shadow-xl p-6 border border-gray-200"></div>

</div>





<!-- ğŸ”¥ğŸ”¥ğŸ”¥ ì—¬ê¸°ì„œë¶€í„° ì „ì²´ êµì²´ (script ì „ì²´) ğŸ”¥ğŸ”¥ğŸ”¥ -->
<script>
let lastSql = "";
let lastEnv = "";

/* ===============================
   ì‹¤í–‰ ë²„íŠ¼ â†’ ì—¬ëŸ¬ SELECT ê²°ê³¼ ì¶œë ¥
   =============================== */
function runQuery() {
    const sql = document.getElementById("sql").value;
    const env = document.getElementById("env").value;

    if (!sql.trim()) {
        alert("SQLì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }

    lastSql = sql;
    lastEnv = env;

    document.getElementById("loading").classList.remove("hidden");

    fetch("/query/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sql, env })
    })
        .then(res => res.json())
        .then(data => {

            const container = document.getElementById("results");
            container.innerHTML = "";

            /* ğŸ”¥ í•µì‹¬: dataê°€ listë©´ ê·¸ëŒ€ë¡œ, objectë©´ data.results ì‚¬ìš© */
            const results = Array.isArray(data) ? data : data.results;

            if (!results) {
                container.innerHTML = "<p class='text-red-500'>ê²°ê³¼ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜ ë°œìƒ</p>";
                return;
            }

            let html = "";

            results.forEach((res, idx) => {
                const rows = res.rows;

                html += `
                    <div class="mb-10">
                        <h3 class="text-lg font-bold mb-3">ğŸ“Œ ê²°ê³¼ ${idx + 1}</h3>
                `;

                if (!rows.length) {
                    html += `<p class='text-gray-500 mb-4'>ë°ì´í„° ì—†ìŒ</p></div>`;
                    return;
                }

                let keys = Object.keys(rows[0]);
                let thead = keys
                    .map(k => `<th class='px-4 py-3 bg-orange-50 border'>${k}</th>`)
                    .join("");

                let tbody = rows
                    .map(r => "<tr>" +
                        keys.map(k => `<td class='px-4 py-2 border'>${r[k] ?? ""}</td>`).join("")
                    + "</tr>")
                    .join("");

                html += `
                    <div class="overflow-auto max-h-[600px] border rounded-xl mb-4">
                        <table class="w-full text-sm">
                            <thead><tr>${thead}</tr></thead>
                            <tbody>${tbody}</tbody>
                        </table>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        })
        .finally(() => {
            document.getElementById("loading").classList.add("hidden");
        });
}




/* ===============================
   ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì—¬ëŸ¬ ì‹œíŠ¸)
   =============================== */
function downloadExcel() {
    if (!lastSql) {
        alert("ë¨¼ì € ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.");
        return;
    }

    fetch("/query/download", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sql: lastSql, env: lastEnv })
    })
        .then(res => res.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "query_result.xlsx";
            a.click();
        });
}
</script>
<!-- ğŸ”¥ğŸ”¥ğŸ”¥ script ë¸”ë¡ ì—¬ê¸°ê¹Œì§€ ì „ì²´ êµì²´ ğŸ”¥ğŸ”¥ğŸ”¥ -->

{% endblock %}
