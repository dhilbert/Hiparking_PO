{% extends "layout.html" %}
{% block page_title %}ì •ê¸°ê¶Œ í™˜ë¶ˆ ê³„ì‚°ê¸°{% endblock %}

{% block content %}

<div class="bg-gradient-to-br from-white to-purple-50 rounded-2xl shadow-xl p-8 mb-10 border border-purple-200">

    <h2 class="text-2xl font-bold text-gray-900 mb-8 flex items-center gap-2">
        <i data-lucide="calculator"></i>
        ì •ê¸°ê¶Œ í™˜ë¶ˆ ê³„ì‚°ê¸°
    </h2>

    <form method="POST" class="flex flex-col gap-10">

        <!-- ì›”ë³„ ìš”ê¸ˆ ì…ë ¥ -->
        <section>
            <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ ì›”ë³„ ìš”ê¸ˆ ì…ë ¥</h3>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                {% for i in range(1, 13) %}
                <div>
                    <label class="block text-gray-600 text-sm mb-1">{{ i }}ì›” ìš”ê¸ˆ</label>
                    <input
                        type="number"
                        name="MonthPrice_{{ i }}"
                        class="px-3 py-2 border rounded-lg w-full"
                        value="{{ form.get('MonthPrice_' ~ i, 100000) }}"
                    >
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- CAP ìš”ê¸ˆ -->
        <section>
            <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ ì¼ ìµœëŒ€ ìš”ê¸ˆ (CAP)</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-gray-600 mb-1">í‰ì¼ ì¼ ìµœëŒ€ ìš”ê¸ˆ</label>
                    <input type="number" name="cap_weekday"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('cap_weekday', 10000) }}">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">í† ìš”ì¼ ì¼ ìµœëŒ€ ìš”ê¸ˆ</label>
                    <input type="number" name="cap_sat"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('cap_sat', 8000) }}">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">ì¼ìš”ì¼ ì¼ ìµœëŒ€ ìš”ê¸ˆ</label>
                    <input type="number" name="cap_sun"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('cap_sun', 5000) }}">
                </div>
            </div>
        </section>

        <!-- ì„œë¹„ìŠ¤ ê¸°ê°„ -->
        <section>
            <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ ì„œë¹„ìŠ¤ ê¸°ê°„</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-gray-600 mb-1">ì‹œì‘ì¼</label>
                    <input type="date" name="FromDate"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('FromDate', '2025-10-16') }}">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                    <input type="date" name="ToDate"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('ToDate', '2025-12-31') }}">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">êµ¬ë§¤ ìˆ˜ëŸ‰</label>
                    <input type="number" name="buy_count"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('buy_count', 1) }}">
                </div>
            </div>
        </section>

        <!-- í™˜ë¶ˆ ì •ë³´ -->
        <section>
            <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ í™˜ë¶ˆ ì •ë³´</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-600 mb-1">í™˜ë¶ˆ ìš”ì²­ ìˆ˜ëŸ‰</label>
                    <input type="number" name="refund_count"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('refund_count', 1) }}">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">í™˜ë¶ˆì¼ì</label>
                    <input type="date" name="refund_date"
                           class="px-3 py-2 border rounded-lg w-full"
                           value="{{ form.get('refund_date', '2025-11-06') }}">
                </div>
            </div>
        </section>

        <button type="submit"
                class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl shadow font-semibold">
            ê³„ì‚°í•˜ê¸°
        </button>

    </form>
</div>


{% if result %}
<!-- ì¶œë ¥ UI ì‹œì‘ -->

<div class="bg-white rounded-2xl shadow-xl p-8 border border-purple-300 mt-10">

    <h3 class="text-xl font-bold mb-6 text-gray-900">ğŸ“Œ ê³„ì‚° ê²°ê³¼</h3>

    <!-- ê³„ì‚°ì‹ ë°•ìŠ¤ -->
    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 mb-8 text-sm">
        <p class="font-semibold mb-2">âœ” ì‹œì‘ì›” ê³„ì‚°ì‹</p>
        <p>{{ result.explain_start }}</p>

        <p class="font-semibold mt-4 mb-2">âœ” ê¸°ì´ìš©ê¸ˆ ê³„ì‚°ì‹</p>
        <p>{{ result.explain_usage }}</p>

        <p class="font-semibold mt-4 mb-2">âœ” ì·¨ì†Œ ìˆ˜ìˆ˜ë£Œ ê³„ì‚°ì‹</p>
        <p>{{ result.explain_cancel }}</p>

        <p class="font-semibold mt-4 mb-2">âœ” ìµœì¢… í™˜ë¶ˆ ê¸ˆì•¡ ê³„ì‚°ì‹</p>
        <p>{{ result.explain_refund }}</p>
    </div>

    <h3 class="text-lg font-bold mb-4">ğŸ“Œ ìµœì¢… í™˜ë¶ˆ ê¸ˆì•¡:
        <span class="text-red-600">{{ result.refund_amount }}ì›</span>
    </h3>

    <!-- ì›”ë³„ ì •ì‚° í…Œì´ë¸” -->
    <h3 class="text-lg font-bold mt-10 mb-4">ğŸ“Œ ì›”ë³„ ì •ì‚° ê²°ê³¼</h3>

    {% set from_month = form.get('FromDate', '2025-10-16')[5:7] | int %}
    {% set to_month = form.get('ToDate', '2025-12-31')[5:7] | int %}
    {% set month_labels = [] %}
    {% for m in range(from_month, to_month + 1) %}
        {% set _ = month_labels.append(m ~ 'ì›”') %}
    {% endfor %}

    <div class="overflow-auto border rounded-xl">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-purple-100">
                    <th class="px-4 py-2 border">ì›”</th>
                    <th class="px-4 py-2 border">ì •ê¸°ê¶Œ ë§¤ì¶œ</th>
                    <th class="px-4 py-2 border">í™˜ë¶ˆì•¡</th>
                    <th class="px-4 py-2 border">ì •ì‚° í›„ ì”ì•¡</th>
                </tr>
            </thead>
            <tbody>
                {% for idx in range(result.monthly_sales|length) %}
                <tr>
                    <td class="px-4 py-2 border">{{ month_labels[idx] }}</td>
                    <td class="px-4 py-2 border">{{ result.monthly_sales[idx] }}</td>
                    <td class="px-4 py-2 border text-red-600">{{ result.refund_dist[idx] }}</td>
                    <td class="px-4 py-2 border">{{ result.final_sales[idx] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endif %}

{% endblock %}
