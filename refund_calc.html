<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì •ê¸°ê¶Œ í™˜ë¶ˆ ê³„ì‚°ê¸°</title>

    <!-- Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

    <!-- lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .hias-header {
            background-color: #ff7f4f !important;
        }
        .hias-header a {
            color: white !important;
        }
        .hias-header .active {
            background-color: white !important;
            color: #ff7f4f !important;
        }

        .detail-box {
            display: none;
            background: #fafafa;
            border-left: 4px solid #8b5cf6;
            padding: 16px;
            margin-top: 12px;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 14px;
            line-height: 1.45;
        }
        .detail-toggle {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>

<body class="bg-[#f9f9f9]">

<!-- NAVIGATION -->
<nav class="hias-header w-full shadow">
    <div class="flex items-center justify-center gap-12 py-4 text-sm font-semibold">
        <a class="px-4 py-2 rounded-lg active">HOME</a>
        <a class="px-4 py-2 rounded-lg">OURS</a>
    </div>
</nav>

<!-- PAGE CONTENT -->
<div class="px-8 py-10 max-w-[1400px] mx-auto">

    <div class="bg-gradient-to-br from-white to-purple-50 rounded-2xl shadow-xl p-8 mb-10 border border-purple-200">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-14 h-14 bg-gradient-to-br from-[#8b5cf6] to-[#7c3aed] rounded-xl flex items-center justify-center">
                <i data-lucide="calculator" class="text-white text-2xl"></i>
            </div>
            <h2 class="text-gray-900 text-2xl font-bold">ì •ê¸°ê¶Œ í™˜ë¶ˆ ê³„ì‚°ê¸° (FULL TRACE MODE)</h2>
        </div>

        <form id="refundForm" class="flex flex-col gap-8">

            <!-- ìš”ê¸ˆí‘œ -->
            <div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ ìš”ê¸ˆí‘œ ì…ë ¥</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <script>
                        for (let i = 1; i <= 12; i++) {
                            document.write(`
                                <div>
                                    <label class="block text-gray-600 text-sm mb-1">${i}ì›” ìš”ê¸ˆ</label>
                                    <input class="px-3 py-2 border rounded-lg w-full"
                                           type="number"
                                           name="MonthPrice_${i}"
                                           value="100000">
                                </div>
                            `);
                        }
                    </script>
                </div>
            </div>

            <!-- CAP ìš”ê¸ˆ -->
            <div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ ì¼ ìµœëŒ€ìš”ê¸ˆ(CAP)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-600 mb-1">í‰ì¼ ì¼ ìµœëŒ€ìš”ê¸ˆ</label>
                        <input class="px-3 py-2 border rounded-lg w-full" type="number" name="cap_weekday" value="10000">
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-1">í† ìš”ì¼ ì¼ ìµœëŒ€ìš”ê¸ˆ</label>
                        <input class="px-3 py-2 border rounded-lg w-full" type="number" name="cap_sat" value="8000">
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-1">ì¼ìš”ì¼ ì¼ ìµœëŒ€ìš”ê¸ˆ</label>
                        <input class="px-3 py-2 border rounded-lg w-full" type="number" name="cap_sun" value="5000">
                    </div>
                </div>
            </div>

            <!-- ê¸°ê°„ -->
            <div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ ì„œë¹„ìŠ¤ ê¸°ê°„</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-600 mb-1">ì„œë¹„ìŠ¤ ì‹œì‘ì¼</label>
                        <input class="px-3 py-2 border rounded-lg w-full"
                               type="date" name="FromDate" value="2025-10-13">
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-1">ì„œë¹„ìŠ¤ ì¢…ë£Œì¼</label>
                        <input class="px-3 py-2 border rounded-lg w-full"
                               type="date" name="ToDate" value="2025-12-31">
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-1">êµ¬ë§¤ ìˆ˜ëŸ‰</label>
                        <input class="px-3 py-2 border rounded-lg w-full"
                               type="number" name="buy_count" value="1">
                    </div>
                </div>
            </div>

            <!-- í™˜ë¶ˆ ì •ë³´ -->
            <div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700">ğŸ“Œ í™˜ë¶ˆ ì •ë³´</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-600 mb-1">í™˜ë¶ˆ ìš”ì²­ ìˆ˜ëŸ‰</label>
                        <input class="px-3 py-2 border rounded-lg w-full"
                               type="number" name="refund_count" value="1">
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-1">í™˜ë¶ˆ ìš”ì²­ì¼</label>
                        <input class="px-3 py-2 border rounded-lg w-full"
                               type="date" name="refund_date" value="2025-11-06">
                    </div>
                </div>
            </div>

            <button type="submit"
                    class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl shadow font-semibold">
                ê³„ì‚°í•˜ê¸°
            </button>

        </form>
    </div>

    <!-- RESULT -->
    <div id="resultArea"></div>
</div>


<script>
/* ------------------------- UTIL ------------------------- */

function daysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
}
function parseDate(str) {
    const [y, m, d] = str.split("-").map(Number);
    return new Date(y, m - 1, d);
}
function dayName(date) {
    return ["ì¼ìš”ì¼","ì›”ìš”ì¼","í™”ìš”ì¼","ìˆ˜ìš”ì¼","ëª©ìš”ì¼","ê¸ˆìš”ì¼","í† ìš”ì¼"][date.getDay()];
}

/* ------------------------- REFUND CALCULATOR ------------------------- */

function RefundCalculator(data) {
    this.fromDate = data.FromDate;
    this.toDate = data.ToDate;
    this.monthPrices = data.monthPrices;
    this.cap_weekday = data.cap_weekday;
    this.cap_sat = data.cap_sat;
    this.cap_sun = data.cap_sun;
    this.refund_date = data.refund_date;
}

/* ì‹œì‘ì›” ë¹„ë¡€ ê³„ì‚° */
RefundCalculator.prototype.calcStartMonth = function() {
    let dt = parseDate(this.fromDate);
    let startDay = dt.getDate();
    let m = dt.getMonth() + 1;
    let full = this.monthPrices[m - 1];
    let totalDays = daysInMonth(dt.getFullYear(), m);

    let proportional =
        startDay < 11
            ? full
            : Math.floor((full / totalDays) * (totalDays - startDay + 1));

    let log =
`
ğŸ“Œ ì‹œì‘ì›” ê³„ì‚°
-------------------------
ì›” = ${m}ì›”
FULL ìš”ê¸ˆ = ${full.toLocaleString()}ì›
ì‹œì‘ì¼ = ${startDay}ì¼
ì´ ì¼ìˆ˜ = ${totalDays}ì¼

ë¹„ë¡€ ê³„ì‚°ì‹:
(FULL / ì´ì¼ìˆ˜) = (${full} / ${totalDays}) = ${(full/totalDays).toFixed(4)}
ìœ íš¨ ì¼ìˆ˜ = ${totalDays} - ${startDay} + 1 = ${totalDays - startDay + 1}
ë¹„ë¡€ê°’ = ìœ„ ê°’ì„ ê³±í•œ í›„ ë‚´ë¦¼(Math.floor)

ìµœì¢… ì‹œì‘ì›” ê¸ˆì•¡ = ${proportional.toLocaleString()}ì›
`;

    return { value: proportional, log };
};

/* ì¤‘ê°„ì›” */
RefundCalculator.prototype.calcMiddleMonths = function() {
    let s = parseDate(this.fromDate).getMonth() + 1;
    let e = parseDate(this.toDate).getMonth() + 1;

    let list = [];
    let log = "ğŸ“Œ ì¤‘ê°„ì›” FULL ìš”ê¸ˆ\n-------------------------\n";

    for (let m = s + 1; m < e; m++) {
        list.push(this.monthPrices[m - 1]);
        log += `${m}ì›” FULL = ${this.monthPrices[m - 1].toLocaleString()}ì›\n`;
    }

    if (list.length === 0) log += "ì¤‘ê°„ì›” ì—†ìŒ\n";

    return { list, log };
};

/* ì¢…ë£Œì›” */
RefundCalculator.prototype.calcEndMonth = function() {
    let m = parseDate(this.toDate).getMonth() + 1;
    let value = this.monthPrices[m - 1];

    let log =
`
ğŸ“Œ ì¢…ë£Œì›” FULL ìš”ê¸ˆ
-------------------------
${m}ì›” FULL = ${value.toLocaleString()}ì›
`;

    return { value, log };
};

/* CAP ê¸°ì´ìš©ê¸ˆ */
RefundCalculator.prototype.calcUsageCost = function() {
    let start = parseDate(this.fromDate);
    let end = parseDate(this.refund_date);

    let weekday = 0, sat = 0, sun = 0;
    let total = 0;

    let log =
"ğŸ“Œ CAP ê¸°ë°˜ ê¸°ì´ìš©ê¸ˆ ìƒì„¸\n-------------------------\n";

    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        let name = dayName(d);
        let dateStr = d.toISOString().slice(0, 10);
        let fee = 0;

        if (d.getDay() >= 1 && d.getDay() <= 5) {
            fee = this.cap_weekday;
            weekday++;
            log += `${dateStr} ${name}: í‰ì¼ ì¼ ìµœëŒ€ìš”ê¸ˆ ${fee.toLocaleString()}ì›\n`;
        } else if (d.getDay() === 6) {
            fee = this.cap_sat;
            sat++;
            log += `${dateStr} ${name}: í† ìš”ì¼ ì¼ ìµœëŒ€ìš”ê¸ˆ ${fee.toLocaleString()}ì›\n`;
        } else {
            fee = this.cap_sun;
            sun++;
            log += `${dateStr} ${name}: ì¼ìš”ì¼ ì¼ ìµœëŒ€ìš”ê¸ˆ ${fee.toLocaleString()}ì›\n`;
        }

        total += fee;
    }

    log += `
-------------------------
í‰ì¼ ìš”ì¼ ìˆ˜ = ${weekday} â†’ ${weekday} * ${this.cap_weekday} = ${(weekday*this.cap_weekday).toLocaleString()}
í† ìš”ì¼ ìš”ì¼ ìˆ˜ = ${sat} â†’ ${sat} * ${this.cap_sat} = ${(sat*this.cap_sat).toLocaleString()}
ì¼ìš”ì¼ ìš”ì¼ ìˆ˜ = ${sun} â†’ ${sun} * ${this.cap_sun} = ${(sun*this.cap_sun).toLocaleString()}

ìµœì¢… ê¸°ì´ìš©ê¸ˆ = ${total.toLocaleString()}ì›
`;

    return { total, log };
};

/* LIFO ì›”ë³„ ì²˜ë¦¬ */
RefundCalculator.prototype.LIFO = function(months, refundAmount, fromDate, toDate) {

    let sM = parseDate(fromDate).getMonth() + 1;
    let eM = parseDate(toDate).getMonth() + 1;

    let labels = [];
    for (let m = sM; m <= eM; m++) labels.push(`${m}ì›”`);

    let refundList = Array(months.length).fill(0);
    let remain = refundAmount;
    let log =
"ğŸ“Œ LIFO í™˜ë¶ˆ ë¶„ë°° ê³¼ì •\n-------------------------\n";

    for (let i = months.length - 1; i >= 0; i--) {
        if (remain <= 0) break;

        let month = labels[i];
        let available = months[i];

        let applied = Math.min(available, remain);

        refundList[i] = applied;
        remain -= applied;

        log += `[${month}] ë§¤ì¶œ ${available.toLocaleString()}ì› ì¤‘ ${applied.toLocaleString()}ì› í™˜ë¶ˆ â†’ ë‚¨ì€ ê¸ˆì•¡: ${(available - applied).toLocaleString()}ì›\n`;
    }

    let finalSales = months.map((m, i) => m - refundList[i]);

    return { refundList, finalSales, labels, log };
};


/* ìµœì¢… ê³„ì‚° */
RefundCalculator.prototype.calculate = function() {

    let start = this.calcStartMonth();
    let mid = this.calcMiddleMonths();
    let end = this.calcEndMonth();
    let usage = this.calcUsageCost();

    let total =
        start.value +
        mid.list.reduce((a,b)=>a+b,0) +
        end.value;

    let cancel_fee = Math.floor((total - usage.total) * 0.2);
    let deduct = usage.total + cancel_fee;
    let refund_amount = total - deduct;

    let months = [start.value, ...mid.list, end.value];

    let lifo = this.LIFO(months, refund_amount, this.fromDate, this.toDate);

    let log =
start.log +
"\n" +
mid.log +
"\n" +
end.log +
`
ğŸ“Œ ì´ ì •ê¸°ê¶Œ ê¸ˆì•¡ ê³„ì‚°
-------------------------
ì‹œì‘ì›” = ${start.value.toLocaleString()}
ì¤‘ê°„ì›” í•©ê³„ = ${mid.list.reduce((a,b)=>a+b,0).toLocaleString()}
ì¢…ë£Œì›” = ${end.value.toLocaleString()}
ì´ ì •ê¸°ê¶Œ ê¸ˆì•¡ = ${total.toLocaleString()}ì›
\n
` +
usage.log +
`
ğŸ“Œ ì·¨ì†Œ ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
-------------------------
(ì •ê¸°ê¶Œê¸ˆì•¡ ${total} - ê¸°ì´ìš©ê¸ˆ ${usage.total}) * 0.2
= ${(total - usage.total)} * 0.2
= ${cancel_fee.toLocaleString()}ì›
\n
ğŸ“Œ ê³µì œì•¡ ê³„ì‚°
-------------------------
ê¸°ì´ìš©ê¸ˆ ${usage.total.toLocaleString()} + ìˆ˜ìˆ˜ë£Œ ${cancel_fee.toLocaleString()}
= ${deduct.toLocaleString()}ì›
\n
ğŸ“Œ í™˜ë¶ˆì•¡ ê³„ì‚°
-------------------------
í™˜ë¶ˆì•¡ = ì •ê¸°ê¶Œ ê¸ˆì•¡ ${total.toLocaleString()} - ê³µì œì•¡ ${deduct.toLocaleString()}
= ${refund_amount.toLocaleString()}ì›
\n
` +
lifo.log
;

    return {
        start: start.value,
        mid: mid.list,
        end: end.value,
        total,
        usage: usage.total,
        cancel_fee,
        deduct,
        refund_amount,
        months,
        refundList: lifo.refundList,
        finalSales: lifo.finalSales,
        labels: lifo.labels,
        log
    };
};


/* ------------------------- FORM EVENT ------------------------- */

document.getElementById("refundForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const f = new FormData(this);

    const monthPrices = [];
    for (let i = 1; i <= 12; i++) monthPrices.push(Number(f.get(`MonthPrice_${i}`)));

    const calc = new RefundCalculator({
        FromDate: f.get("FromDate"),
        ToDate: f.get("ToDate"),
        monthPrices,
        cap_weekday: Number(f.get("cap_weekday")),
        cap_sat: Number(f.get("cap_sat")),
        cap_sun: Number(f.get("cap_sun")),
        refund_date: f.get("refund_date")
    });

    const r = calc.calculate();
    renderResult(r);
});


/* ------------------------- RESULT RENDER ------------------------- */

function renderResult(r) {

    let rows = "";
    for (let i = 0; i < r.months.length; i++) {
        rows += `
            <tr>
                <td class="border px-3 py-2">${r.labels[i]}</td>
                <td class="border px-3 py-2">${r.months[i].toLocaleString()}</td>
                <td class="border px-3 py-2 text-red-600">${r.refundList[i].toLocaleString()}</td>
                <td class="border px-3 py-2 font-semibold">${r.finalSales[i].toLocaleString()}</td>
            </tr>
        `;
    }

    document.getElementById("resultArea").innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-200">

            <h3 class="text-xl font-bold mb-6">ğŸ“Œ ê³„ì‚° ê²°ê³¼ ìš”ì•½</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                    <div class="font-semibold text-blue-800">ì •ê¸°ê¶Œ ì´ ê¸ˆì•¡</div>
                    <div class="text-2xl font-bold">${r.total.toLocaleString()}ì›</div>
                </div>

                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    <div class="font-semibold text-yellow-800">ê³µì œì•¡</div>
                    <div class="text-2xl font-bold">${r.deduct.toLocaleString()}ì›</div>
                </div>

                <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                    <div class="font-semibold text-green-800">í™˜ë¶ˆì•¡</div>
                    <div class="text-2xl font-bold">${r.refund_amount.toLocaleString()}ì›</div>
                </div>
            </div>

            <div class="mt-10">
                <div class="detail-toggle text-purple-700 font-semibold flex items-center gap-2"
                     onclick="toggleDetail()">
                    <span>ìƒì„¸ë³´ê¸° (âˆ¨)</span>
                </div>

                <div id="detailBox" class="detail-box">${r.log}</div>
            </div>

            <h3 class="text-lg font-bold mt-10 mb-4">ğŸ“Œ ì›”ë³„ ë§¤ì¶œ / í™˜ë¶ˆ ë°°ë¶„ (LIFO)</h3>

            <table class="w-full text-sm border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-3 py-2">ì›”</th>
                        <th class="border px-3 py-2">ë§¤ì¶œì•¡</th>
                        <th class="border px-3 py-2 text-red-600">í™˜ë¶ˆì•¡(LIFO)</th>
                        <th class="border px-3 py-2">ì •ì‚° í›„ ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>

        </div>
    `;

    lucide.createIcons();
}


function toggleDetail() {
    let box = document.getElementById("detailBox");
    box.style.display = box.style.display === "block" ? "none" : "block";
}
</script>

</body>
</html>
